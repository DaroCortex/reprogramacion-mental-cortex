<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Detector de Colores - Academia Cortex</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #0f1419;
  --panel: #1a1f26;
  --border: #2d333b;
  --accent: #4a9eff;
  --accent-dim: #2a5a7a;
  --text: #e6edf3;
  --text-dim: #7d8590;
  --success: #3fb950;
  --error: #f85149;
  --radius: 8px;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow: hidden;
}

/* ============ MODAL OVERLAY ============ */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.85);
  display: flex; align-items: center; justify-content: center;
  z-index: 1000;
}
.modal-overlay.hidden { display: none; }

.modal {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 40px;
  max-width: 500px;
  width: 90%;
  text-align: center;
}
.modal h1 {
  font-size: 1.6rem;
  font-weight: 600;
  margin-bottom: 8px;
  letter-spacing: 2px;
  color: var(--text);
}
.modal .subtitle {
  color: var(--text-dim);
  font-size: 0.9rem;
  margin-bottom: 32px;
}
.modal label {
  display: block;
  text-align: left;
  font-size: 0.85rem;
  color: var(--text-dim);
  margin-bottom: 6px;
  margin-top: 16px;
}
.modal input[type="text"],
.modal input[type="number"] {
  width: 100%;
  padding: 10px 14px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text);
  font-size: 1rem;
  outline: none;
  transition: border-color 0.2s;
}
.modal input:focus { border-color: var(--accent); }

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 10px 24px;
  border: none;
  border-radius: var(--radius);
  font-size: 0.95rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-primary {
  background: var(--accent);
  color: #fff;
}
.btn-primary:hover { background: #5aabff; }
.btn-primary:disabled {
  background: var(--accent-dim);
  cursor: not-allowed;
  opacity: 0.6;
}
.btn-secondary {
  background: var(--border);
  color: var(--text);
}
.btn-secondary:hover { background: #3d444d; }
.btn-danger {
  background: var(--error);
  color: #fff;
}
.btn-success {
  background: var(--success);
  color: #fff;
}

.modal .btn { margin-top: 24px; width: 100%; }

/* ============ CALIBRATION MODAL ============ */
#calibrationModal .modal {
  max-width: 600px;
}
.calibration-video-wrap {
  position: relative;
  width: 320px;
  height: 240px;
  margin: 16px auto;
  border-radius: var(--radius);
  overflow: hidden;
  border: 2px solid var(--border);
}
.calibration-video-wrap video {
  width: 100%; height: 100%;
  object-fit: cover;
  transform: scaleX(-1);
}
.calibration-zone {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  width: 80px; height: 80px;
  border: 2px solid var(--accent);
  border-radius: 4px;
  pointer-events: none;
}
.calibration-progress {
  color: var(--text-dim);
  font-size: 0.85rem;
  margin-top: 8px;
}
.samples-row {
  display: flex;
  gap: 8px;
  justify-content: center;
  margin-top: 12px;
}
.sample-swatch {
  width: 64px; height: 64px;
  border-radius: 6px;
  border: 3px solid var(--border);
}
.sample-swatch.active { border-color: var(--accent); }
.sample-swatch.captured { border-color: var(--success); }

.color-name-input {
  display: flex;
  gap: 12px;
  margin-top: 20px;
  align-items: center;
  padding: 16px;
  background: var(--bg);
  border-radius: var(--radius);
  border: 1px solid var(--border);
}
.color-name-input input {
  flex: 1;
  font-size: 1.2rem;
  padding: 12px 16px;
}
.color-preview {
  width: 80px; height: 80px;
  border-radius: var(--radius);
  border: 3px solid var(--border);
  flex-shrink: 0;
}
.color-name-input .btn {
  margin-top: 0;
  width: auto;
  padding: 12px 24px;
  font-size: 1.1rem;
}

/* ============ MAIN SESSION LAYOUT ============ */
#sessionScreen {
  display: none;
  height: 100vh;
  grid-template-columns: 1fr 320px;
  grid-template-rows: 48px 1fr 48px;
}
#sessionScreen.active { display: grid; }

.top-bar {
  grid-column: 1 / -1;
  background: var(--panel);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
}
.top-bar h2 {
  font-size: 0.95rem;
  font-weight: 600;
  letter-spacing: 1.5px;
  color: var(--text-dim);
}
.top-bar .session-info {
  font-size: 0.8rem;
  color: var(--text-dim);
}

.video-area {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #000;
  overflow: hidden;
}
.video-area video {
  width: 100%; height: 100%;
  object-fit: cover;
  transform: scaleX(-1);
}
.detection-zone {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  width: 100px; height: 100px;
  border: 2px solid var(--accent);
  border-radius: 8px;
  pointer-events: none;
  transition: border-color 0.3s;
}
.detection-zone.detecting {
  border-color: var(--success);
  box-shadow: 0 0 20px rgba(63, 185, 80, 0.3);
}
.detection-label {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.75);
  padding: 8px 24px;
  border-radius: 20px;
  font-size: 1.1rem;
  font-weight: 500;
  color: var(--text);
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.3s;
}
.detection-label.visible { opacity: 1; }

.recording-indicator {
  position: absolute;
  top: 16px; left: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
  background: rgba(248, 81, 73, 0.9);
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 500;
  opacity: 0;
  transition: opacity 0.3s;
}
.recording-indicator.visible { opacity: 1; }
.recording-dot {
  width: 8px; height: 8px;
  background: #fff;
  border-radius: 50%;
  animation: blink 1s infinite;
}
@keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

.waiting-confirm {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0,0,0,0.85);
  padding: 24px 40px;
  border-radius: 12px;
  text-align: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
}
.waiting-confirm.visible { opacity: 1; pointer-events: auto; }
.waiting-confirm .detected-color {
  font-size: 2rem;
  font-weight: 700;
  margin-bottom: 12px;
}
.waiting-confirm .confirm-hint {
  color: var(--text-dim);
  font-size: 0.9rem;
}

/* ============ SIDEBAR ============ */
.sidebar {
  background: var(--panel);
  border-left: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.sidebar-section {
  padding: 16px;
  border-bottom: 1px solid var(--border);
}
.sidebar-section h3 {
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 12px;
}

.stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 8px;
}
.stat-card {
  background: var(--bg);
  border-radius: var(--radius);
  padding: 10px;
  text-align: center;
}
.stat-value {
  font-size: 1.4rem;
  font-weight: 700;
}
.stat-value.success { color: var(--success); }
.stat-value.error { color: var(--error); }
.stat-value.total { color: var(--accent); }
.stat-label {
  font-size: 0.7rem;
  color: var(--text-dim);
  margin-top: 2px;
}

.colors-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.color-chip {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 10px;
  background: var(--bg);
  border-radius: var(--radius);
  font-size: 0.85rem;
}
.color-chip-swatch {
  width: 16px; height: 16px;
  border-radius: 3px;
  border: 1px solid var(--border);
  flex-shrink: 0;
}
.color-chip-name { flex: 1; }
.color-chip-stats {
  font-size: 0.75rem;
  color: var(--text-dim);
}

.add-color-btn {
  width: 100%;
  margin-top: 8px;
  padding: 6px;
  font-size: 0.8rem;
}

.history-list {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}
.history-list h3 {
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 12px;
}
.history-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 0;
  border-bottom: 1px solid var(--border);
  font-size: 0.85rem;
}
.history-icon { font-size: 0.75rem; }
.history-icon.success { color: var(--success); }
.history-icon.error { color: var(--error); }
.history-color { flex: 1; }
.history-audio { font-size: 0.7rem; color: var(--text-dim); }
.history-thumb {
  width: 28px; height: 28px;
  border-radius: 3px;
  object-fit: cover;
  border: 1px solid var(--border);
}

/* ============ BOTTOM BAR ============ */
.bottom-bar {
  grid-column: 1 / -1;
  background: var(--panel);
  border-top: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 24px;
  padding: 0 20px;
  font-size: 0.8rem;
  color: var(--text-dim);
}
.bottom-bar kbd {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 2px 8px;
  font-family: inherit;
  font-size: 0.75rem;
}

/* ============ REPORT SCREEN ============ */
#reportScreen {
  display: none;
  height: 100vh;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 24px;
  padding: 40px;
}
#reportScreen.active { display: flex; }

.report-preview {
  max-height: 70vh;
  border-radius: var(--radius);
  border: 1px solid var(--border);
}
.report-actions {
  display: flex;
  gap: 12px;
}

/* ============ UTILITY ============ */
.hidden { display: none !important; }

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }
</style>
</head>
<body>

<!-- ===================== WELCOME MODAL ===================== -->
<div id="welcomeModal" class="modal-overlay">
  <div class="modal">
    <h1>ACADEMIA CORTEX</h1>
    <p class="subtitle">Detector de Colores</p>

    <label for="studentName">Nombre del estudiante</label>
    <input type="text" id="studentName" placeholder="Ej: Ana, Juan..." autofocus>

    <label for="colorCount">Cantidad de colores a usar</label>
    <input type="number" id="colorCount" min="2" max="12" value="2">

    <button class="btn btn-primary" id="btnStartCalibration">Comenzar calibraci&oacute;n</button>
  </div>
</div>

<!-- ===================== CALIBRATION MODAL ===================== -->
<div id="calibrationModal" class="modal-overlay hidden">
  <div class="modal">
    <h1 id="calibrationTitle">Calibrar color 1</h1>
    <p class="calibration-progress" id="calibrationProgress">Color 1 de 2</p>

    <div class="calibration-video-wrap">
      <video id="calibrationVideo" autoplay playsinline muted></video>
      <div class="calibration-zone"></div>
    </div>

    <p id="calibrationInstruction" style="color:var(--text-dim);font-size:0.85rem;margin-top:8px;line-height:1.5;">
      Coloc&aacute; la cartulina frente a la c&aacute;mara.<br>
      Vamos a tomar <strong>3 muestras</strong> mov&eacute; la cartulina entre cada captura para captar diferentes reflejos de luz.<br>
      Presion&aacute; <kbd>ESPACIO</kbd> o el bot&oacute;n para cada muestra.
    </p>

    <div class="samples-row" id="samplesRow">
      <div class="sample-swatch active" id="swatch0"></div>
      <div class="sample-swatch" id="swatch1"></div>
      <div class="sample-swatch" id="swatch2"></div>
    </div>

    <button class="btn btn-primary" id="btnCaptureSample">Capturar muestra</button>

    <div class="color-name-input hidden" id="colorNameSection">
      <div class="color-preview" id="colorPreview"></div>
      <input type="text" id="colorNameInput" placeholder="Nombre del color (ej: Rojo)">
      <button class="btn btn-success" id="btnConfirmColor">OK</button>
    </div>
  </div>
</div>

<!-- ===================== SESSION SCREEN ===================== -->
<div id="sessionScreen">
  <div class="top-bar">
    <h2>ACADEMIA CORTEX</h2>
    <span class="session-info" id="sessionInfo"></span>
  </div>

  <div class="video-area">
    <video id="sessionVideo" autoplay playsinline muted></video>
    <div class="detection-zone" id="detectionZone"></div>
    <div class="detection-label" id="detectionLabel"></div>
    <div class="recording-indicator" id="recordingIndicator">
      <div class="recording-dot"></div>
      <span id="recordingTimer">Grabando 5s</span>
    </div>
    <div class="waiting-confirm" id="waitingConfirm">
      <div class="detected-color" id="detectedColorText"></div>
      <div class="confirm-hint">Presion&aacute; <kbd>S</kbd> = S&iacute; &nbsp; <kbd>N</kbd> = No</div>
    </div>
  </div>

  <div class="sidebar">
    <div class="sidebar-section">
      <h3>Estad&iacute;sticas</h3>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value success" id="statHits">0</div>
          <div class="stat-label">Aciertos</div>
        </div>
        <div class="stat-card">
          <div class="stat-value error" id="statMisses">0</div>
          <div class="stat-label">Errores</div>
        </div>
        <div class="stat-card">
          <div class="stat-value total" id="statTotal">0</div>
          <div class="stat-label">Total</div>
        </div>
      </div>
    </div>

    <div class="sidebar-section">
      <h3>Colores configurados</h3>
      <div class="colors-list" id="colorsList"></div>
      <button class="btn btn-secondary add-color-btn" id="btnAddColor">+ Agregar color</button>
    </div>

    <div class="history-list" id="historyList">
      <h3>Historial</h3>
    </div>

    <div class="sidebar-section" style="margin-top:auto;">
      <button class="btn btn-primary" id="btnFinishSession" style="width:100%;">Finalizar sesi&oacute;n</button>
    </div>
  </div>

  <div class="bottom-bar">
    <span><kbd>ESPACIO</kbd> Detectar color</span>
    <span><kbd>S</kbd> / <kbd>N</kbd> Confirmar</span>
    <span><kbd>ESPACIO</kbd> x3 Grabar audio</span>
    <span><kbd>ESC</kbd> Finalizar</span>
  </div>
</div>

<!-- ===================== REPORT SCREEN ===================== -->
<div id="reportScreen">
  <canvas id="reportCanvas" style="display:none;"></canvas>
  <img id="reportPreview" class="report-preview" alt="Reporte">
  <div class="report-actions">
    <button class="btn btn-primary" id="btnDownloadReport">Descargar reporte</button>
    <button class="btn btn-secondary" id="btnNewSession">Nueva sesi&oacute;n</button>
  </div>
</div>

<script>
// ======================================================================
// APP STATE
// ======================================================================
const state = {
  phase: 'welcome', // welcome | calibration | session | report
  studentName: '',
  colorCount: 2,
  colors: [],            // [{name, h, s, v, rgb: [r,g,b]}]
  calibration: {
    current: 0,
    samples: [],          // collected HSV samples for current color
    sampleCount: 0
  },
  session: {
    history: [],          // [{color, correct, thumbnail, audioBlob, timestamp}]
    hits: 0,
    misses: 0,
  },
  detection: {
    active: false,
    waitingConfirm: false,
    lastDetected: null,
    lastThumbnail: null,
  },
  recording: {
    active: false,
    mediaRecorder: null,
    chunks: [],
  },
  spaceTimestamps: [],    // for triple-space detection
  stream: null,
  audioStream: null,
};

// ======================================================================
// DOM REFS
// ======================================================================
const $ = id => document.getElementById(id);

const dom = {
  welcomeModal: $('welcomeModal'),
  studentName: $('studentName'),
  colorCount: $('colorCount'),
  btnStartCalibration: $('btnStartCalibration'),

  calibrationModal: $('calibrationModal'),
  calibrationTitle: $('calibrationTitle'),
  calibrationProgress: $('calibrationProgress'),
  calibrationVideo: $('calibrationVideo'),
  calibrationInstruction: $('calibrationInstruction'),
  samplesRow: $('samplesRow'),
  btnCaptureSample: $('btnCaptureSample'),
  colorNameSection: $('colorNameSection'),
  colorNameInput: $('colorNameInput'),
  colorPreview: $('colorPreview'),
  btnConfirmColor: $('btnConfirmColor'),

  sessionScreen: $('sessionScreen'),
  sessionVideo: $('sessionVideo'),
  sessionInfo: $('sessionInfo'),
  detectionZone: $('detectionZone'),
  detectionLabel: $('detectionLabel'),
  recordingIndicator: $('recordingIndicator'),
  recordingTimer: $('recordingTimer'),
  waitingConfirm: $('waitingConfirm'),
  detectedColorText: $('detectedColorText'),

  statHits: $('statHits'),
  statMisses: $('statMisses'),
  statTotal: $('statTotal'),
  colorsList: $('colorsList'),
  btnAddColor: $('btnAddColor'),
  historyList: $('historyList'),
  btnFinishSession: $('btnFinishSession'),

  reportScreen: $('reportScreen'),
  reportCanvas: $('reportCanvas'),
  reportPreview: $('reportPreview'),
  btnDownloadReport: $('btnDownloadReport'),
  btnNewSession: $('btnNewSession'),
};

// Hidden canvas for sampling
const sampleCanvas = document.createElement('canvas');
const sampleCtx = sampleCanvas.getContext('2d', { willReadFrequently: true });

// ======================================================================
// VOICE SYNTHESIS — Selección inteligente de la mejor voz disponible
// ======================================================================

// Lista de voces preferidas en orden de calidad (las mejores primero)
const PREFERRED_VOICES = [
  // macOS high-quality voices
  'Mónica', 'Monica', 'Paulina', 'Isabela', 'Grandma (Spanish (Mexico))',
  // Google high-quality (Chrome)
  'Google español', 'Google español de Estados Unidos',
  // Windows quality voices
  'Microsoft Sabina', 'Microsoft Helena', 'Microsoft Laura',
  // Edge online voices
  'Microsoft Elena Online', 'Microsoft Dalia Online',
];

let cachedVoice = null;

function findBestVoice() {
  if (cachedVoice) return cachedVoice;

  const voices = window.speechSynthesis.getVoices();
  if (!voices.length) return null;

  // 1. Buscar por nombre en la lista de preferidas
  for (const preferred of PREFERRED_VOICES) {
    const found = voices.find(v =>
      v.name.includes(preferred) && v.lang.startsWith('es')
    );
    if (found) { cachedVoice = found; return found; }
  }

  // 2. Preferir voces femeninas en español (suelen ser de mejor calidad)
  const esFemale = voices.find(v =>
    v.lang.startsWith('es') && !v.localService
  );
  if (esFemale) { cachedVoice = esFemale; return esFemale; }

  // 3. Cualquier voz en español argentino
  const esAR = voices.find(v => v.lang === 'es-AR');
  if (esAR) { cachedVoice = esAR; return esAR; }

  // 4. Cualquier voz en español latinoamericano
  const esLatam = voices.find(v =>
    v.lang.startsWith('es') && !v.lang.endsWith('ES')
  );
  if (esLatam) { cachedVoice = esLatam; return esLatam; }

  // 5. Cualquier español
  const esAny = voices.find(v => v.lang.startsWith('es'));
  if (esAny) { cachedVoice = esAny; return esAny; }

  return null;
}

function speak(text) {
  if (!('speechSynthesis' in window)) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'es-AR';
  u.rate = 0.95;   // Un poco más lento suena más natural
  u.pitch = 1.05;  // Tono ligeramente alto suena más cálido

  const voice = findBestVoice();
  if (voice) u.voice = voice;
  window.speechSynthesis.speak(u);
}

// Preload voices (Chrome carga voces de forma asíncrona)
if ('speechSynthesis' in window) {
  window.speechSynthesis.getVoices();
  window.speechSynthesis.onvoiceschanged = () => {
    cachedVoice = null; // Reset para re-buscar con las nuevas voces
    findBestVoice();
  };
}

// ======================================================================
// AUDIO BEEP
// ======================================================================
let audioCtx = null;
function getAudioContext() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}

function beep(freq = 440, duration = 0.15) {
  const ctx = getAudioContext();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.connect(gain);
  gain.connect(ctx.destination);
  osc.frequency.value = freq;
  gain.gain.value = 0.3;
  osc.start();
  gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
  osc.stop(ctx.currentTime + duration);
}

// ======================================================================
// COLOR CONVERSION - RGB to HSV
// ======================================================================
function rgbToHsv(r, g, b) {
  r /= 255; g /= 255; b /= 255;
  const max = Math.max(r, g, b);
  const min = Math.min(r, g, b);
  const d = max - min;
  let h = 0, s = max === 0 ? 0 : d / max, v = max;

  if (d !== 0) {
    switch (max) {
      case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
      case g: h = ((b - r) / d + 2) / 6; break;
      case b: h = ((r - g) / d + 4) / 6; break;
    }
  }
  return { h: h * 360, s: s * 100, v: v * 100 };
}

// ======================================================================
// SAMPLE COLOR FROM VIDEO
// ======================================================================
function sampleColorFromVideo(video, zoneSize = 80) {
  const w = video.videoWidth;
  const h = video.videoHeight;
  if (!w || !h) return null;

  sampleCanvas.width = w;
  sampleCanvas.height = h;
  sampleCtx.drawImage(video, 0, 0);

  const cx = Math.floor(w / 2);
  const cy = Math.floor(h / 2);
  const half = Math.floor(zoneSize / 2);
  const x0 = Math.max(0, cx - half);
  const y0 = Math.max(0, cy - half);
  const x1 = Math.min(w, cx + half);
  const y1 = Math.min(h, cy + half);

  const imageData = sampleCtx.getImageData(x0, y0, x1 - x0, y1 - y0);
  const data = imageData.data;
  const pixels = data.length / 4;

  let totalR = 0, totalG = 0, totalB = 0;
  for (let i = 0; i < data.length; i += 4) {
    totalR += data[i];
    totalG += data[i + 1];
    totalB += data[i + 2];
  }

  const r = Math.round(totalR / pixels);
  const g = Math.round(totalG / pixels);
  const b = Math.round(totalB / pixels);
  const hsv = rgbToHsv(r, g, b);

  return { r, g, b, ...hsv };
}

// ======================================================================
// CAPTURE THUMBNAIL FROM VIDEO
// ======================================================================
function captureThumbnail(video) {
  const c = document.createElement('canvas');
  c.width = 160;
  c.height = 120;
  const ctx = c.getContext('2d');
  ctx.drawImage(video, 0, 0, 160, 120);
  return c.toDataURL('image/jpeg', 0.6);
}

// ======================================================================
// DETECT CLOSEST COLOR (HSV distance)
// ======================================================================
function detectColor(sample) {
  if (!state.colors.length || !sample) return null;

  let bestMatch = null;
  let bestDist = Infinity;

  for (const c of state.colors) {
    // Hue distance (circular)
    let dh = Math.abs(sample.h - c.h);
    if (dh > 180) dh = 360 - dh;

    // Weighted distance: hue matters most for cartulinas
    const ds = Math.abs(sample.s - c.s);
    const dv = Math.abs(sample.v - c.v);

    // For low-saturation colors (white, black, gray), rely more on V
    const satWeight = (c.s < 15) ? 0.5 : 3.0;
    const dist = (dh * satWeight) + (ds * 0.8) + (dv * 0.5);

    if (dist < bestDist) {
      bestDist = dist;
      bestMatch = c;
    }
  }

  // Confidence threshold
  if (bestDist > 120) return null;
  return bestMatch;
}

// ======================================================================
// CAMERA SETUP
// ======================================================================
async function setupCamera() {
  try {
    state.stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment', width: { ideal: 640 }, height: { ideal: 480 } },
      audio: false
    });
    state.audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    return true;
  } catch (e) {
    alert('No se pudo acceder a la c\u00e1mara o micr\u00f3fono. Asegurate de dar permisos.');
    return false;
  }
}

function attachVideoStream(videoEl) {
  if (state.stream) {
    videoEl.srcObject = state.stream;
  }
}

// ======================================================================
// PHASE: WELCOME
// ======================================================================
dom.btnStartCalibration.addEventListener('click', async () => {
  const name = dom.studentName.value.trim();
  const count = parseInt(dom.colorCount.value);
  if (!name) { dom.studentName.focus(); return; }
  if (count < 2 || count > 12) { dom.colorCount.focus(); return; }

  state.studentName = name;
  state.colorCount = count;

  dom.btnStartCalibration.disabled = true;
  dom.btnStartCalibration.textContent = 'Iniciando c\u00e1mara...';

  const ok = await setupCamera();
  if (!ok) {
    dom.btnStartCalibration.disabled = false;
    dom.btnStartCalibration.textContent = 'Comenzar calibraci\u00f3n';
    return;
  }

  startCalibration();
});

// Enter key on inputs
dom.studentName.addEventListener('keydown', e => {
  if (e.key === 'Enter') dom.colorCount.focus();
});
dom.colorCount.addEventListener('keydown', e => {
  if (e.key === 'Enter') dom.btnStartCalibration.click();
});

// ======================================================================
// PHASE: CALIBRATION
// ======================================================================
function startCalibration() {
  state.phase = 'calibration';
  state.calibration.current = 0;
  state.calibration.samples = [];
  state.calibration.sampleCount = 0;
  state.colors = [];

  dom.welcomeModal.classList.add('hidden');
  dom.calibrationModal.classList.remove('hidden');

  attachVideoStream(dom.calibrationVideo);
  updateCalibrationUI();

  speak(`Vamos a calibrar ${state.colorCount} colores. Cada color lleva 3 muestras, mové la cartulina entre cada una para captar diferentes reflejos. Color número 1. Colocá la cartulina y presioná espacio.`);
}

function updateCalibrationUI() {
  const i = state.calibration.current + 1;
  dom.calibrationTitle.textContent = `Calibrar color ${i}`;
  dom.calibrationProgress.textContent = `Color ${i} de ${state.colorCount}`;

  // Reset swatches
  for (let s = 0; s < 3; s++) {
    const sw = $(`swatch${s}`);
    sw.style.backgroundColor = 'transparent';
    sw.className = 'sample-swatch' + (s === 0 ? ' active' : '');
  }

  dom.btnCaptureSample.classList.remove('hidden');
  dom.btnCaptureSample.disabled = false;
  dom.colorNameSection.classList.add('hidden');
  dom.colorNameInput.value = '';
  dom.colorNameInput.disabled = false;
  dom.btnConfirmColor.disabled = false;
  state.calibration.samples = [];
  state.calibration.sampleCount = 0;
}

function captureSample() {
  // No capturar más de 3 muestras
  if (state.calibration.sampleCount >= 3) return;

  const sample = sampleColorFromVideo(dom.calibrationVideo);
  if (!sample) return;

  const idx = state.calibration.sampleCount;
  state.calibration.samples.push(sample);
  state.calibration.sampleCount++;

  const sw = $(`swatch${idx}`);
  sw.style.backgroundColor = `rgb(${sample.r},${sample.g},${sample.b})`;
  sw.className = 'sample-swatch captured';

  beep(660, 0.1);

  if (idx < 2) {
    const next = $(`swatch${idx + 1}`);
    if (next) next.className = 'sample-swatch active';
    const remaining = 2 - idx;
    speak(`Capturado. Mové la cartulina un poco y presioná espacio. ${remaining} más.`);
  } else {
    // All 3 captured
    dom.btnCaptureSample.classList.add('hidden');
    dom.colorNameSection.classList.remove('hidden');

    // Average color
    const avg = averageSamples(state.calibration.samples);
    dom.colorPreview.style.backgroundColor = `rgb(${avg.r},${avg.g},${avg.b})`;
    dom.colorNameInput.focus();

    speak('Perfecto. Escrib\u00ed el nombre del color.');
  }
}

function averageSamples(samples) {
  const n = samples.length;
  let tr = 0, tg = 0, tb = 0;
  // For hue averaging we use circular mean
  let sinH = 0, cosH = 0, ts = 0, tv = 0;

  for (const s of samples) {
    tr += s.r; tg += s.g; tb += s.b;
    const hRad = (s.h * Math.PI) / 180;
    sinH += Math.sin(hRad);
    cosH += Math.cos(hRad);
    ts += s.s;
    tv += s.v;
  }

  let avgH = (Math.atan2(sinH / n, cosH / n) * 180) / Math.PI;
  if (avgH < 0) avgH += 360;

  return {
    r: Math.round(tr / n),
    g: Math.round(tg / n),
    b: Math.round(tb / n),
    h: avgH,
    s: ts / n,
    v: tv / n,
  };
}

dom.btnCaptureSample.addEventListener('click', captureSample);

function confirmColor() {
  // Bloquear si ya se está procesando o el input está deshabilitado
  if (dom.colorNameInput.disabled) return;

  const name = dom.colorNameInput.value.trim();
  if (!name) { dom.colorNameInput.focus(); return; }

  // Deshabilitar TODO inmediatamente para evitar doble ejecución
  dom.colorNameInput.disabled = true;
  dom.btnConfirmColor.disabled = true;

  const avg = averageSamples(state.calibration.samples);
  state.colors.push({
    name,
    h: avg.h,
    s: avg.s,
    v: avg.v,
    rgb: [avg.r, avg.g, avg.b],
  });

  speak(`Color ${name} guardado.`);
  beep(880, 0.15);

  state.calibration.current++;

  if (state.calibration.current < state.colorCount) {
    setTimeout(() => {
      updateCalibrationUI();
      const num = state.calibration.current + 1;
      speak(`Color número ${num}. Colocá la nueva cartulina y tomá 3 muestras con espacio.`);
    }, 600);
  } else {
    // Calibration complete
    const names = state.colors.map(c => c.name).join(', ');
    speak(`Calibración completa. Configuraste: ${names}. Podés empezar.`);
    setTimeout(startSession, 1500);
  }
}

// ======================================================================
// PHASE: SESSION
// ======================================================================
function startSession() {
  state.phase = 'session';
  dom.calibrationModal.classList.add('hidden');
  dom.sessionScreen.classList.add('active');

  attachVideoStream(dom.sessionVideo);
  dom.sessionInfo.textContent = `${state.studentName} \u2022 ${new Date().toLocaleDateString('es-AR')}`;

  updateSidebar();
}

function updateSidebar() {
  dom.statHits.textContent = state.session.hits;
  dom.statMisses.textContent = state.session.misses;
  dom.statTotal.textContent = state.session.hits + state.session.misses;

  // Colors list
  dom.colorsList.innerHTML = '';
  for (const c of state.colors) {
    const colorHits = state.session.history.filter(h => h.color === c.name && h.correct).length;
    const colorTotal = state.session.history.filter(h => h.color === c.name).length;

    const chip = document.createElement('div');
    chip.className = 'color-chip';
    chip.innerHTML = `
      <div class="color-chip-swatch" style="background:rgb(${c.rgb.join(',')})"></div>
      <span class="color-chip-name">${c.name}</span>
      <span class="color-chip-stats">${colorHits}/${colorTotal}</span>
    `;
    dom.colorsList.appendChild(chip);
  }

  // History
  const items = dom.historyList.querySelectorAll('.history-item');
  items.forEach(i => i.remove());

  for (const entry of [...state.session.history].reverse()) {
    const item = document.createElement('div');
    item.className = 'history-item';
    item.innerHTML = `
      <span class="history-icon ${entry.correct ? 'success' : 'error'}">${entry.correct ? '\u2713' : '\u2717'}</span>
      <span class="history-color">${entry.color}</span>
      ${entry.audioBlob ? '<span class="history-audio">\uD83C\uDFA4</span>' : ''}
      ${entry.thumbnail ? `<img class="history-thumb" src="${entry.thumbnail}" alt="">` : ''}
    `;
    dom.historyList.appendChild(item);
  }
}

// ======================================================================
// DETECTION
// ======================================================================
function performDetection() {
  if (state.detection.waitingConfirm || state.recording.active) return;

  const sample = sampleColorFromVideo(dom.sessionVideo);
  const match = detectColor(sample);

  if (!match) {
    speak('No se detect\u00f3 ning\u00fan color conocido.');
    beep(200, 0.3);
    return;
  }

  state.detection.lastDetected = match.name;
  state.detection.lastThumbnail = captureThumbnail(dom.sessionVideo);
  state.detection.waitingConfirm = true;

  // Visual feedback
  dom.detectionZone.classList.add('detecting');
  dom.detectedColorText.textContent = match.name;
  dom.detectedColorText.style.color = `rgb(${match.rgb.join(',')})`;
  dom.waitingConfirm.classList.add('visible');

  // Flash label
  dom.detectionLabel.textContent = match.name;
  dom.detectionLabel.classList.add('visible');

  // Voice
  beep(660, 0.1);
  setTimeout(() => {
    speak(`${match.name}. Presion\u00e1 S para s\u00ed, o N para no.`);
  }, 150);
}

function confirmDetection(correct) {
  if (!state.detection.waitingConfirm) return;

  state.detection.waitingConfirm = false;
  dom.detectionZone.classList.remove('detecting');
  dom.waitingConfirm.classList.remove('visible');

  const entry = {
    color: state.detection.lastDetected,
    correct,
    thumbnail: state.detection.lastThumbnail,
    audioBlob: null,
    timestamp: Date.now(),
  };

  state.session.history.push(entry);
  if (correct) {
    state.session.hits++;
    speak('Correcto.');
    beep(880, 0.12);
  } else {
    state.session.misses++;
    speak('Error.');
    beep(220, 0.3);
  }

  setTimeout(() => {
    dom.detectionLabel.classList.remove('visible');
  }, 1500);

  updateSidebar();
}

// ======================================================================
// AUDIO RECORDING (5 seconds)
// ======================================================================
function startRecording() {
  if (state.recording.active || !state.audioStream) return;

  state.recording.active = true;
  state.recording.chunks = [];

  const mr = new MediaRecorder(state.audioStream);
  state.recording.mediaRecorder = mr;

  mr.ondataavailable = e => {
    if (e.data.size > 0) state.recording.chunks.push(e.data);
  };

  mr.onstop = () => {
    const blob = new Blob(state.recording.chunks, { type: 'audio/webm' });
    // Attach to last history entry
    if (state.session.history.length > 0) {
      state.session.history[state.session.history.length - 1].audioBlob = blob;
    }
    state.recording.active = false;
    dom.recordingIndicator.classList.remove('visible');
    beep(880, 0.15);
    speak('Grabaci\u00f3n finalizada.');
    updateSidebar();
  };

  speak('Grabando.');
  beep(440, 0.2);

  dom.recordingIndicator.classList.add('visible');
  mr.start();

  // Countdown
  let remaining = 5;
  dom.recordingTimer.textContent = `Grabando ${remaining}s`;
  const interval = setInterval(() => {
    remaining--;
    dom.recordingTimer.textContent = `Grabando ${remaining}s`;
    if (remaining <= 0) clearInterval(interval);
  }, 1000);

  setTimeout(() => {
    clearInterval(interval);
    if (mr.state === 'recording') mr.stop();
  }, 5000);
}

// ======================================================================
// ADD COLOR (mid-session)
// ======================================================================
dom.btnAddColor.addEventListener('click', () => {
  state.colorCount++;
  state.calibration.current = state.colorCount - 1;

  // Show calibration modal briefly
  dom.sessionScreen.classList.remove('active');
  dom.calibrationModal.classList.remove('hidden');
  attachVideoStream(dom.calibrationVideo);
  updateCalibrationUI();
  dom.calibrationProgress.textContent = `Agregar color nuevo`;
  dom.calibrationTitle.textContent = `Calibrar color nuevo`;

  speak('Coloc\u00e1 la cartulina nueva frente a la c\u00e1mara y presion\u00e1 espacio.');
});

// ======================================================================
// KEYBOARD HANDLING
// ======================================================================
document.addEventListener('keydown', e => {
  // Ignore if typing in an input
  if (e.target.tagName === 'INPUT') {
    if (e.key === ' ' && state.phase === 'calibration') {
      e.preventDefault();
      captureSample();
    }
    return;
  }

  if (e.key === ' ' || e.code === 'Space') {
    e.preventDefault();

    if (state.phase === 'calibration') {
      captureSample();
      return;
    }

    if (state.phase !== 'session') return;

    // Triple space detection
    const now = Date.now();
    state.spaceTimestamps.push(now);
    // Keep only last 3
    if (state.spaceTimestamps.length > 3) state.spaceTimestamps.shift();

    if (state.spaceTimestamps.length >= 3) {
      const first = state.spaceTimestamps[state.spaceTimestamps.length - 3];
      if (now - first < 1500) {
        // Triple space -> record
        state.spaceTimestamps = [];
        startRecording();
        return;
      }
    }

    // Single space -> detect (with small delay to check for triple)
    clearTimeout(state.detection.spaceTimeout);
    state.detection.spaceTimeout = setTimeout(() => {
      if (!state.recording.active) {
        performDetection();
      }
    }, 400);
    return;
  }

  if (state.phase === 'session' && state.detection.waitingConfirm) {
    if (e.key === 's' || e.key === 'S') {
      confirmDetection(true);
      return;
    }
    if (e.key === 'n' || e.key === 'N') {
      confirmDetection(false);
      return;
    }
  }

  if (e.key === 'Escape' && state.phase === 'session') {
    finishSession();
  }
});

// ======================================================================
// FINISH SESSION -> REPORT
// ======================================================================
dom.btnFinishSession.addEventListener('click', finishSession);

function finishSession() {
  if (state.session.history.length === 0) {
    // Sin registros, volver al inicio directamente
    state.phase = 'welcome';
    dom.sessionScreen.classList.remove('active');
    dom.welcomeModal.classList.remove('hidden');
    dom.studentName.value = state.studentName;
    dom.studentName.focus();
    dom.btnStartCalibration.disabled = false;
    dom.btnStartCalibration.textContent = 'Comenzar calibraci\u00f3n';
    speak('Sesi\u00f3n finalizada.');
    return;
  }

  state.phase = 'report';
  dom.sessionScreen.classList.remove('active');
  dom.reportScreen.classList.add('active');

  speak('Sesi\u00f3n finalizada. Generando reporte.');
  generateReport();
}

// ======================================================================
// REPORT GENERATION (9:16 for Instagram)
// ======================================================================
function generateReport() {
  const canvas = dom.reportCanvas;
  const W = 1080;
  const H = 1920;
  canvas.width = W;
  canvas.height = H;
  const ctx = canvas.getContext('2d');

  // Background
  ctx.fillStyle = '#0f1419';
  ctx.fillRect(0, 0, W, H);

  // Header bar
  ctx.fillStyle = '#1a1f26';
  ctx.fillRect(0, 0, W, 200);
  ctx.strokeStyle = '#2d333b';
  ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(0, 200); ctx.lineTo(W, 200); ctx.stroke();

  // Title
  ctx.fillStyle = '#e6edf3';
  ctx.font = '700 48px -apple-system, BlinkMacSystemFont, sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('ACADEMIA CORTEX', W / 2, 90);

  ctx.font = '400 28px -apple-system, BlinkMacSystemFont, sans-serif';
  ctx.fillStyle = '#7d8590';
  ctx.fillText('Detector de Colores \u2022 Reporte de Sesi\u00f3n', W / 2, 140);

  // Student info
  ctx.fillStyle = '#1a1f26';
  ctx.fillRect(40, 230, W - 80, 120);
  ctx.strokeStyle = '#2d333b';
  ctx.strokeRect(40, 230, W - 80, 120);

  ctx.textAlign = 'left';
  ctx.font = '500 30px -apple-system, BlinkMacSystemFont, sans-serif';
  ctx.fillStyle = '#e6edf3';
  ctx.fillText(`Estudiante: ${state.studentName}`, 80, 285);

  ctx.font = '400 26px -apple-system, BlinkMacSystemFont, sans-serif';
  ctx.fillStyle = '#7d8590';
  const dateStr = new Date().toLocaleDateString('es-AR', {
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
  });
  ctx.fillText(dateStr, 80, 330);

  // Stats cards
  const total = state.session.hits + state.session.misses;
  const pct = total > 0 ? Math.round((state.session.hits / total) * 100) : 0;

  const statsY = 400;
  const cardW = (W - 120) / 3;

  // Hits
  drawStatCard(ctx, 40, statsY, cardW, 'Aciertos', state.session.hits, '#3fb950');
  // Errors
  drawStatCard(ctx, 60 + cardW, statsY, cardW, 'Errores', state.session.misses, '#f85149');
  // Percentage
  drawStatCard(ctx, 80 + cardW * 2, statsY, cardW, 'Precisi\u00f3n', `${pct}%`, '#4a9eff');

  // Per-color stats
  let colorY = statsY + 160;
  ctx.font = '600 24px -apple-system, BlinkMacSystemFont, sans-serif';
  ctx.fillStyle = '#7d8590';
  ctx.textAlign = 'left';
  ctx.fillText('RESULTADOS POR COLOR', 60, colorY);
  colorY += 16;

  for (const c of state.colors) {
    const hits = state.session.history.filter(h => h.color === c.name && h.correct).length;
    const tot = state.session.history.filter(h => h.color === c.name).length;
    if (tot === 0) continue;

    colorY += 48;
    // Swatch
    ctx.fillStyle = `rgb(${c.rgb.join(',')})`;
    ctx.beginPath();
    ctx.roundRect(60, colorY - 20, 28, 28, 4);
    ctx.fill();

    // Name
    ctx.fillStyle = '#e6edf3';
    ctx.font = '500 26px -apple-system, BlinkMacSystemFont, sans-serif';
    ctx.fillText(c.name, 100, colorY + 4);

    // Bar background
    const barX = 320;
    const barW = W - 380;
    const barH = 20;
    ctx.fillStyle = '#2d333b';
    ctx.beginPath();
    ctx.roundRect(barX, colorY - 10, barW, barH, 10);
    ctx.fill();

    // Bar fill
    const fillW = tot > 0 ? (hits / tot) * barW : 0;
    ctx.fillStyle = '#3fb950';
    ctx.beginPath();
    ctx.roundRect(barX, colorY - 10, Math.max(fillW, 10), barH, 10);
    ctx.fill();

    // Stat text
    ctx.fillStyle = '#7d8590';
    ctx.font = '400 22px -apple-system, BlinkMacSystemFont, sans-serif';
    ctx.textAlign = 'right';
    ctx.fillText(`${hits}/${tot}`, W - 60, colorY + 4);
    ctx.textAlign = 'left';
  }

  // Thumbnails grid
  colorY += 80;
  ctx.font = '600 24px -apple-system, BlinkMacSystemFont, sans-serif';
  ctx.fillStyle = '#7d8590';
  ctx.fillText('CAPTURAS', 60, colorY);
  colorY += 20;

  const thumbSize = 140;
  const thumbGap = 12;
  const cols = Math.floor((W - 80) / (thumbSize + thumbGap));
  const entriesWithThumb = state.session.history.filter(e => e.thumbnail);

  entriesWithThumb.forEach((entry, idx) => {
    const col = idx % cols;
    const row = Math.floor(idx / cols);
    const tx = 40 + col * (thumbSize + thumbGap);
    const ty = colorY + row * (thumbSize + thumbGap + 28);

    if (ty + thumbSize > H - 100) return; // Don't overflow

    // Border color
    ctx.strokeStyle = entry.correct ? '#3fb950' : '#f85149';
    ctx.lineWidth = 3;
    ctx.strokeRect(tx, ty, thumbSize, thumbSize);

    // Draw thumbnail
    const img = new Image();
    img.src = entry.thumbnail;
    try {
      ctx.drawImage(img, tx + 2, ty + 2, thumbSize - 4, thumbSize - 4);
    } catch(e) {}

    // Color label
    ctx.fillStyle = entry.correct ? '#3fb950' : '#f85149';
    ctx.font = '500 16px -apple-system, BlinkMacSystemFont, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(
      `${entry.correct ? '\u2713' : '\u2717'} ${entry.color}${entry.audioBlob ? ' \uD83C\uDFA4' : ''}`,
      tx + thumbSize / 2,
      ty + thumbSize + 20
    );
    ctx.textAlign = 'left';
  });

  // Footer
  ctx.fillStyle = '#1a1f26';
  ctx.fillRect(0, H - 70, W, 70);
  ctx.strokeStyle = '#2d333b';
  ctx.beginPath(); ctx.moveTo(0, H - 70); ctx.lineTo(W, H - 70); ctx.stroke();

  ctx.textAlign = 'center';
  ctx.font = '400 22px -apple-system, BlinkMacSystemFont, sans-serif';
  ctx.fillStyle = '#7d8590';
  ctx.fillText('academia-cortex.com', W / 2, H - 28);

  // Render preview
  // Wait a tick for thumbnail images to load
  setTimeout(() => {
    // Re-draw thumbnails (images may have loaded now)
    redrawThumbnails(ctx, entriesWithThumb, colorY + 20, thumbSize, thumbGap, cols, W, H);

    const dataUrl = canvas.toDataURL('image/png');
    dom.reportPreview.src = dataUrl;
  }, 200);
}

function redrawThumbnails(ctx, entries, startY, size, gap, cols, W, H) {
  entries.forEach((entry, idx) => {
    const col = idx % cols;
    const row = Math.floor(idx / cols);
    const tx = 40 + col * (size + gap);
    const ty = startY + row * (size + gap + 28);
    if (ty + size > H - 100) return;

    const img = new Image();
    img.onload = () => {
      ctx.drawImage(img, tx + 2, ty + 2, size - 4, size - 4);
      dom.reportPreview.src = dom.reportCanvas.toDataURL('image/png');
    };
    img.src = entry.thumbnail;
  });
}

function drawStatCard(ctx, x, y, w, label, value, color) {
  ctx.fillStyle = '#1a1f26';
  ctx.beginPath();
  ctx.roundRect(x, y, w, 110, 12);
  ctx.fill();
  ctx.strokeStyle = '#2d333b';
  ctx.beginPath();
  ctx.roundRect(x, y, w, 110, 12);
  ctx.stroke();

  ctx.textAlign = 'center';
  ctx.fillStyle = color;
  ctx.font = '700 44px -apple-system, BlinkMacSystemFont, sans-serif';
  ctx.fillText(String(value), x + w / 2, y + 55);

  ctx.fillStyle = '#7d8590';
  ctx.font = '500 20px -apple-system, BlinkMacSystemFont, sans-serif';
  ctx.fillText(label, x + w / 2, y + 90);
  ctx.textAlign = 'left';
}

// ======================================================================
// DOWNLOAD REPORT
// ======================================================================
dom.btnDownloadReport.addEventListener('click', () => {
  const link = document.createElement('a');
  link.download = `reporte-${state.studentName.replace(/\s+/g, '-')}-${new Date().toISOString().slice(0,10)}.png`;
  link.href = dom.reportCanvas.toDataURL('image/png');
  link.click();
});

// ======================================================================
// NEW SESSION
// ======================================================================
dom.btnNewSession.addEventListener('click', () => {
  // Reset state
  state.session = { history: [], hits: 0, misses: 0 };
  state.detection = { active: false, waitingConfirm: false, lastDetected: null, lastThumbnail: null };
  state.spaceTimestamps = [];

  dom.reportScreen.classList.remove('active');

  // Go back to welcome
  state.phase = 'welcome';
  dom.welcomeModal.classList.remove('hidden');
  dom.studentName.value = '';
  dom.studentName.focus();
  dom.btnStartCalibration.disabled = false;
  dom.btnStartCalibration.textContent = 'Comenzar calibraci\u00f3n';
});

// ======================================================================
// CONFIRM COLOR — Un solo listener para botón y Enter
// ======================================================================
function handleConfirmAndContinue() {
  confirmColor();
  // Si estábamos agregando un color mid-session, volver a sesión
  if (state.colors.length >= state.colorCount && state.session.hits + state.session.misses > 0) {
    dom.calibrationModal.classList.add('hidden');
    dom.sessionScreen.classList.add('active');
    state.phase = 'session';
    attachVideoStream(dom.sessionVideo);
    updateSidebar();
    const lastColor = state.colors[state.colors.length - 1];
    speak(`Color ${lastColor.name} agregado. Podés continuar.`);
  }
}

dom.btnConfirmColor.addEventListener('click', handleConfirmAndContinue);
dom.colorNameInput.addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    e.stopPropagation();
    handleConfirmAndContinue();
  }
});

// ======================================================================
// PREVENT SPACE FROM SCROLLING
// ======================================================================
window.addEventListener('keydown', e => {
  if (e.code === 'Space' && e.target === document.body) {
    e.preventDefault();
  }
});

</script>
</body>
</html>